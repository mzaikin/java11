<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;6.&nbsp;Migration to a Modular Application</title><link rel="stylesheet" type="text/css" href="ocpjd11-upgrade-guide.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Exam 1Z0-817: Upgrade OCP Java 6, 7 &amp; 8 to Java SE 11 Developer Study Guide"><link rel="up" href="pt01.html" title="Part&nbsp;I.&nbsp;Exam Objectives"><link rel="prev" href="ch05s03.html" title="5.3.&nbsp; Use Stream API with Files"><link rel="next" href="ch06s02.html" title="6.2.&nbsp; Use jdeps to determine dependencies and identify way to address the cyclic dependencies"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;6.&nbsp;Migration to a Modular Application</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch05s03.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;I.&nbsp;Exam Objectives</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ch06s02.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chap6"></a>Chapter&nbsp;6.&nbsp;Migration to a Modular Application</h2></div></div></div>
			
			<div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="c6s1"></a>6.1.&nbsp;
					 Migrate the application developed using a Java version prior to SE 9 to SE 11 including top-down and bottom-up migration, splitting a Java SE 8 application into modules for migration
				</h2></div></div></div>
				
				<div class="note" style="margin-left: 0.1in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="81px"><img alt="[Note]" src="images.admon/note.gif"></td><th align="left"></th></tr><tr><td align="left" valign="top">
					<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
							<p>
								<a class="xref" href="bi01.html#JDEPS_DOC" title="JDeps documentation">[JDEPS_DOC]</a> <code class="code">jdeps</code> tool documentation								
							</p>
						</li></ul></div>
				</td></tr></table></div>
				<p>
					Assume we have a utility library packaged as separate <code class="code">info-logger.jar</code> JAR (Java 8.0, non-modular):
					</p><pre class="programlisting">
C:\1Z0-817\INFO-LOGGER
&#9492;&#9472;&#9472;&#9472;by
    &#9492;&#9472;&#9472;&#9472;iba
        &#9492;&#9472;&#9472;&#9472;logging                
                InfoLogger.java
					</pre><p>
					</p><pre class="programlisting">
package by.iba.logging;

import java.util.logging.Logger;

public class InfoLogger {
    
    private static final Logger LOG = Logger.getLogger(InfoLogger.class.getName());
    
    public static void log(String msg) {
        LOG.info(msg);
    }

    public static Logger getLog() {
        return LOG;
    }
}					</pre><p>
					</p><pre class="programlisting">
C:\1Z0-817\info-logger&gt;javac by\iba\logging\InfoLogger.java
					</pre><p>
					</p><pre class="programlisting">
C:\1Z0-817\info-logger&gt;jar cvf info-logger.jar .
added manifest
adding: by/(in = 0) (out= 0)(stored 0%)
adding: by/iba/(in = 0) (out= 0)(stored 0%)
adding: by/iba/logging/(in = 0) (out= 0)(stored 0%)
adding: by/iba/logging/InfoLogger.class(in = 667) (out= 370)(deflated 44%)
adding: by/iba/logging/InfoLogger.java(in = 328) (out= 181)(deflated 44%)
					</pre><p>
				</p>
				<p>
					And application (Java 8.0, non-modular) JAR:
					</p><pre class="programlisting">
C:\1Z0-817\APP
&#9492;&#9472;&#9472;&#9472;by
    &#9492;&#9472;&#9472;&#9472;iba
        &#9492;&#9472;&#9472;&#9472;app
                App.java
					</pre><p>
					</p><pre class="programlisting">
package by.iba.app;

import by.iba.logging.InfoLogger;
import java.util.logging.Logger;

public class App {

    public static void main(String... args) {
        InfoLogger.log("Application started ...");
        Logger logger = InfoLogger.getLog();
        logger.info("Application finished.");
    }    
}
					</pre><p>
					Application depends on <code class="code">info-logger.jar</code> utility JAR:
					</p><pre class="programlisting">
C:\1Z0-817\app&gt;javac -cp ../info-logger/info-logger.jar by\iba\app\App.java
					</pre><p>
					</p><pre class="programlisting">
C:\1Z0-817\app&gt;jar --verbose --create --file app.jar .
added manifest
adding: by/(in = 0) (out= 0)(stored 0%)
adding: by/iba/(in = 0) (out= 0)(stored 0%)
adding: by/iba/app/(in = 0) (out= 0)(stored 0%)
adding: by/iba/app/App.class(in = 513) (out= 348)(deflated 32%)
adding: by/iba/app/App.java(in = 320) (out= 176)(deflated 45%)					
					</pre><p>					
				</p>
				<p>
					We should get similar hierarchy:
					</p><pre class="programlisting">
C:\1Z0-817
&#9500;&#9472;&#9472;&#9472;app
&#9474;   &#9474;   app.jar
&#9474;   &#9474;
&#9474;   &#9492;&#9472;&#9472;&#9472;by
&#9474;       &#9492;&#9472;&#9472;&#9472;iba
&#9474;           &#9492;&#9472;&#9472;&#9472;app
&#9474;                   App.class
&#9474;                   App.java
&#9474;
&#9492;&#9472;&#9472;&#9472;info-logger
    &#9474;   info-logger.jar
    &#9474;
    &#9492;&#9472;&#9472;&#9472;by
        &#9492;&#9472;&#9472;&#9472;iba
            &#9492;&#9472;&#9472;&#9472;logging
                    InfoLogger.class
                    InfoLogger.java
					</pre><p>
				</p>
				<p>
					Now you can run the application in Java 8.0 style:
					</p><pre class="programlisting">
C:\1Z0-817&gt;java -classpath ./info-logger/info-logger.jar;./app/app.jar by.iba.app.App
Apr 20, 2019 11:56:21 PM by.iba.logging.InfoLogger log
INFO: Application started ...
Apr 20, 2019 11:56:21 PM by.iba.app.App main
INFO: Application finished.
					</pre><p>
				</p>
				<p>
					The structure of application looks as follows:
					</p><div class="figure"><a name="d5e2503"></a><p class="title"><b>Figure&nbsp;6.1.&nbsp;Java application before migration</b></p><div class="figure-contents">
  						
  						<div class="mediaobject"><img src="images/c6s100.gif" alt="Java application before migration"></div>
					</div></div><p><br class="figure-break">
				</p>
				<p>
					<span class="bold"><strong>Migrating from the top down</strong></span>
				</p>
				<p>
					We put all JARs (application and utility) to module path rather than class path and make application JAR modular.
				</p>
				<p>
					Check dependencies for application to create proper module descriptor:
					</p><pre class="programlisting">
C:\1Z0-817&gt;jdeps --module-path info-logger/info-logger.jar -s app/app.jar
app.jar -&gt; info.logger
app.jar -&gt; java.base
app.jar -&gt; java.logging
info.logger -&gt; java.base
info.logger -&gt; java.logging
					</pre><p>
					Application depends on 3 modules: <code class="code">info.logger</code> (automatic module name for <code class="code">info-logger.jar</code>), <code class="code">java.base</code> (implicitly required by 
					any module), and <code class="code">java.logging</code>.
				</p>
				<p>
					Assume we have no source for <code class="code">info-logger.jar</code> and use it as automatic module:
					</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
							<p>
								Real module, but without module descriptor.
							</p>
						</li><li class="listitem">
							<p>
								We do not change someone else's JAR file
							</p>
						</li><li class="listitem">
							<p>
								Module name derived from JAR file name
							</p>
						</li><li class="listitem">
							<p>
								Exports all its packages
							</p>
						</li><li class="listitem">
							<p>
								Requires all other modules
							</p>
						</li></ul></div><p>
				</p>
				<p>
					Based on this we create a module definition for <code class="code">app</code> application module:
					</p><pre class="programlisting">
module app {
    requires info.logger;
    requires java.logging;
}
					</pre><p>
					</p><pre class="programlisting">
C:\1Z0-817\APP
&#9474;   module-info.java
&#9474;
&#9492;&#9472;&#9472;&#9472;by
    &#9492;&#9472;&#9472;&#9472;iba
        &#9492;&#9472;&#9472;&#9472;app
                App.java
					</pre><p>
					Recompile the application code:
					</p><pre class="programlisting">
javac -p ../info-logger/info-logger.jar module-info.java by\iba\app\App.java
					</pre><p>
					NOTE: <code class="code">-p</code> is synonym for <code class="code">--module-path</code>
				</p>
				<p>
					Recreate the application modular JAR file:
					</p><pre class="programlisting">
C:\1Z0-817\app&gt;jar --verbose --create --file app.jar .
added manifest
added module-info: module-info.class
adding: by/(in = 0) (out= 0)(stored 0%)
adding: by/iba/(in = 0) (out= 0)(stored 0%)
adding: by/iba/app/(in = 0) (out= 0)(stored 0%)
adding: by/iba/app/App.class(in = 513) (out= 348)(deflated 32%)
adding: by/iba/app/App.java(in = 320) (out= 176)(deflated 45%)
adding: module-info.java(in = 70) (out= 53)(deflated 24%)
					</pre><p>
				</p>
				<p>
					Run the application:
					</p><pre class="programlisting">
C:\1Z0-817&gt;java --module-path ./info-logger/info-logger.jar;./app/app.jar -m app/by.iba.app.App
Apr 21, 2019 12:33:03 AM by.iba.logging.InfoLogger log
INFO: Application started ...
Apr 21, 2019 12:33:03 AM by.iba.app.App main
INFO: Application finished.
					</pre><p>
					NOTE: <code class="code">-m</code> is synonym for <code class="code">--module</code>
				</p>
				<p>
					</p><div class="figure"><a name="d5e2544"></a><p class="title"><b>Figure&nbsp;6.2.&nbsp;Java application after top-down migration</b></p><div class="figure-contents">
  						
  						<div class="mediaobject"><img src="images/c6s101.gif" alt="Java application after top-down migration"></div>
					</div></div><p><br class="figure-break">
				</p>
				<p>
					<span class="bold"><strong>Migrating from the bottom up</strong></span>					
				</p>
				<p>
					We make all library JARs modular and put on the module path, keep application JAR non-modular and put on the class path (it will become part of the unnamed module).
				</p>
				<p>
					Revert <code class="code">app.jar</code> back to non-modular (it will be part of unnamed module):
					</p><pre class="programlisting">
C:\1Z0-817\app&gt;jar -tvf app.jar
     0 Sun Apr 21 10:46:24 AST 2019 META-INF/
    94 Sun Apr 21 10:46:24 AST 2019 META-INF/MANIFEST.MF
     0 Fri Apr 19 22:29:28 AST 2019 by/
     0 Fri Apr 19 22:29:34 AST 2019 by/iba/
     0 Sat Apr 20 23:40:42 AST 2019 by/iba/app/
   513 Sun Apr 21 00:28:22 AST 2019 by/iba/app/App.class
   320 Sat Apr 20 23:40:32 AST 2019 by/iba/app/App.java
					</pre><p>
				</p>
				<p>
					The unnamed module:
					</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
							<p>
								Reads all other modules
							</p>
						</li><li class="listitem">
							<p>
								Exports all its packages
							</p>
						</li><li class="listitem">
							<p>
								Cannot have any dependencies declared on it
							</p>
						</li><li class="listitem">
							<p>
								Cannot be accessed by a named module (the one with <code class="code">module-info.class</code>)
							</p>
						</li></ul></div><p>
				</p>
				<p>
					Check dependencies for library utility JAR to create a module definition (<code class="code">module-info.java</code>):
					</p><pre class="programlisting">
C:\1Z0-817&gt;jdeps -s info-logger/info-logger.jar
info-logger.jar -&gt; java.base
info-logger.jar -&gt; java.logging
					</pre><p>
					Since <code class="code">java.base</code> always implicitly required by any module, we may think that we require only <code class="code">java.logging</code> module
					and come up with this definition:
					</p><pre class="programlisting">
// WRONG
module info.logger {  
    requires java.logging;
}
					</pre><p>
					But this module definition is wrong, because the library must export packages to be used by application (or by unnamed) 
					module.	We need to use <code class="code">jdeps</code> to generate accurate <code class="code">module-info.java</code> for us:
					</p><pre class="programlisting">
C:\1Z0-817\info-logger&gt;jdeps --generate-module-info . info-logger.jar
writing to .\info.logger\module-info.java
					</pre><p>
					The generated <code class="code">module-info.java</code> is writen into <code class="code">info.logger\module-info.java</code>, move it 1 level higher.
					The correct definition will look as follows (NOTE: <code class="code">requires transitive</code> also was recognized and added by <code class="code">jdeps</code>):
					</p><pre class="programlisting">
// CORRECT
module info.logger {
    requires transitive java.logging;
    exports by.iba.logging;
}
					</pre><p>
				</p>
				<div class="important" style="margin-left: 0.1in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images.admon/important.gif"></td><th align="left"></th></tr><tr><td align="left" valign="top">
					<p>
						NOTE: module name may not contain dash character, it get replaced with period character automatically by <code class="code">jdeps</code> utility.
					</p>
				</td></tr></table></div>
				<p>					
					Re-compile the utility modular JAR sources:
					</p><pre class="programlisting">
C:\1Z0-817\info-logger&gt;javac module-info.java by\iba\logging\InfoLogger.java
					</pre><p>
					</p><pre class="programlisting">
C:\1Z0-817\INFO-LOGGER
&#9474;   module-info.class
&#9474;   module-info.java
&#9474;
&#9492;&#9472;&#9472;&#9472;by
    &#9492;&#9472;&#9472;&#9472;iba
        &#9492;&#9472;&#9472;&#9472;logging
                InfoLogger.class
                InfoLogger.java
					</pre><p>
					Re-create the modular JAR:
					</p><pre class="programlisting">
C:\1Z0-817\info-logger&gt;jar --verbose --create --file info-logger.jar .
added manifest
added module-info: module-info.class
adding: by/(in = 0) (out= 0)(stored 0%)
adding: by/iba/(in = 0) (out= 0)(stored 0%)
adding: by/iba/logging/(in = 0) (out= 0)(stored 0%)
adding: by/iba/logging/InfoLogger.class(in = 667) (out= 370)(deflated 44%)
adding: by/iba/logging/InfoLogger.java(in = 328) (out= 181)(deflated 44%)
adding: module-info.java(in = 97) (out= 78)(deflated 19%)
					</pre><p>					
				</p>
				<p>
					Now we can run the modularized application:
					</p><pre class="programlisting">
C:\1Z0-817&gt;java --add-modules info.logger --module-path info-logger/info-logger.jar --class-path app/app.jar  by.iba.app.App
Apr 21, 2019 11:45:06 AM by.iba.logging.InfoLogger log
INFO: Application started ...
Apr 21, 2019 11:45:06 AM by.iba.app.App main
INFO: Application finished.
					</pre><p>
				</p>
				<div class="important" style="margin-left: 0.1in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images.admon/important.gif"></td><th align="left"></th></tr><tr><td align="left" valign="top">
					<p>
						When the compiler compiles code in the unnamed module, or the Java launcher is invoked and the main class of the application 
						is loaded from the class path into the unnamed module of the application class loader, then the 
						<span class="bold"><strong>default set of root modules for the unnamed module is computed as follows</strong></span>:
						</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
								<p>
									The <code class="code">java.se</code> module is a root, if it exists. If it does not exist then every 
									<code class="code">java.*</code> module on the upgrade module path or among the system modules that exports at least one 
									package, without qualification, is a root.
								</p>
							</li><li class="listitem">
								<p>
									Every <code class="code">non-java.*</code> module on the upgrade module path or among the system modules that exports at least 
									one package, without qualification, is also a root.
								</p>
							</li></ul></div><p>
					</p>
					<p>
						Otherwise, the default set of root modules depends upon the phase:
						</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
								<p>
									At compile time it is usually the set of modules being compiled;
								</p>
							</li><li class="listitem">
								<p>
									At link time it is empty;
								</p>
							</li><li class="listitem">
								<p>
									At run time it is the application's main module, as specified via the  <code class="code">--module</code> (or <code class="code">-m</code> for short) launcher option.
								</p>
							</li></ul></div><p>
						It is occasionally necessary to add modules to the default root set in order to ensure that specific platform, library, or 
						service-provider modules will be present in the module graph. In any phase the option <code class="code">--add-modules &lt;module&gt;(,&lt;module*&gt;)*</code> 
						where <code class="code">&lt;module&gt;</code> is a module name, adds the named modules to the default set of root modules.
					</p>
				</td></tr></table></div>
				<p>
					So, we had to use <code class="code">--add-modules info.logger</code> option to tell the Java runtime to include the module by name to the default root set. There are also
					predefined constants: <code class="code">ALL-MODULE-PATH</code>, <code class="code">ALL-DEFAULT</code>, and <code class="code">ALL-SYSTEM</code>.
				</p>
				<p>
					The <code class="code">--module-path</code> option tells the Java runtime the location of our modules.
				</p>
				<p>
					</p><div class="figure"><a name="d5e2620"></a><p class="title"><b>Figure&nbsp;6.3.&nbsp;Java application after bottom-up migration</b></p><div class="figure-contents">
  						
  						<div class="mediaobject"><img src="images/c6s102.gif" alt="Java application after bottom-up migration"></div>
					</div></div><p><br class="figure-break">
				</p>
			</div>
			
		</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch05s03.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="pt01.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ch06s02.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.3.&nbsp;
					 Use Stream API with <code class="code">Files</code>
				&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;6.2.&nbsp;
					Use <code class="code">jdeps</code> to determine dependencies and identify way to address the cyclic dependencies
				</td></tr></table></div></body></html>